# Clawdbot 项目架构文档

## 项目概述

Clawdbot 是一个功能强大的**个人AI助手**，可以在用户自己的设备上运行，支持多个通信渠道（WhatsApp、Telegram、Slack、Discord等），具有强大的插件系统和AI提供商集成能力。

## 快速阅读指南

### 🚀 新手入门路径
1. **先读本文档** - 了解整体架构
2. **查看 `README.md`** - 了解项目基本信息和安装方法
3. **阅读 `src/index.ts`** - 了解核心模块导出
4. **查看 `src/entry.ts`** - 了解CLI入口点
5. **浏览 `src/cli/program/`** - 了解命令行接口设计

### 📁 核心目录优先级
- **高优先级**: `src/gateway/`, `src/auto-reply/`, `src/agents/`, `src/channels/`
- **中优先级**: `src/plugins/`, `src/providers/`, `src/routing/`
- **低优先级**: `src/config/`, `src/infra/`, `src/utils/`

## 整体架构

### 架构设计理念
- **模块化设计**: 高度模块化，每个功能都是独立的模块
- **插件驱动**: 通过插件系统实现功能扩展
- **网关中心**: 以网关作为中心枢纽，统一管理所有通信
- **多渠道支持**: 统一接口支持多种通信平台

### 核心组件关系图
```
┌─────────────────────────────────────────────────────────────┐
│                        Clawdbot                             │
├─────────────────────────────────────────────────────────────┤
│  CLI Interface (src/cli/)                                   │
│  ├── Commands (src/commands/)                               │
│  └── Program Builder (src/cli/program/)                     │
├─────────────────────────────────────────────────────────────┤
│  Gateway Server (src/gateway/)                              │
│  ├── WebSocket/HTTP Server                                  │
│  ├── Authentication & Authorization                         │
│  ├── Real-time Communication                                │
│  └── Channel Management                                      │
├─────────────────────────────────────────────────────────────┤
│  Message Processing Pipeline                                │
│  ├── Auto-Reply System (src/auto-reply/)                    │
│  ├── Agent Runner (src/auto-reply/reply/)                   │
│  └── Message Routing (src/routing/)                         │
├─────────────────────────────────────────────────────────────┤
│  AI Integration Layer                                       │
│  ├── Agent System (src/agents/)                             │
│  ├── Model Selection & Fallback                             │
│  └── Provider Integration (src/providers/)                  │
├─────────────────────────────────────────────────────────────┤
│  Channel Abstraction Layer                                  │
│  ├── Core Channels (src/telegram/, src/discord/, etc.)      │
│  └── Extension Channels (extensions/*)                      │
├─────────────────────────────────────────────────────────────┤
│  Plugin System (src/plugins/)                               │
│  ├── Plugin Loader & Registry                               │
│  ├── Hook System                                            │
│  └── Service Management                                      │
└─────────────────────────────────────────────────────────────┘
```

## 详细模块说明

### 1. CLI 系统 (`src/cli/`, `src/commands/`)

**核心文件**:
- `src/entry.ts` - 主入口点，处理进程管理
- `src/cli/program/build-program.ts` - CLI程序构建器
- `src/commands/` - 具体命令实现

**主要命令**:
```bash
clawdbot onboard      # 引导配置向导
clawdbot gateway      # 启动网关服务
clawdbot agent        # AI代理交互
clawdbot channels     # 渠道管理
clawdbot status       # 系统状态检查
```

### 2. 网关系统 (`src/gateway/`)

**核心架构**:
- `server.impl.ts` - 网关服务器核心实现
- `server-http.ts` - HTTP服务处理
- `server-channels.ts` - 渠道服务管理
- `server-chat.ts` - 聊天服务和事件处理
- `auth.ts` - 认证管理

**功能特性**:
- WebSocket连接管理
- HTTP API服务
- 渠道消息路由
- 实时通信
- 认证和授权

### 3. 消息处理管道 (`src/auto-reply/`)

**处理流程**:
```
消息接收 → 预处理 → 指令解析 → AI处理 → 响应生成 → 消息发送
```

**核心文件**:
- `reply/get-reply.ts` - 主要回复逻辑入口
- `reply/agent-runner.ts` - AI代理执行器
- `reply/get-reply-run.ts` - 回复执行流程
- `templating.ts` - 消息模板处理

### 4. AI代理系统 (`src/agents/`)

**核心组件**:
- `agent-scope.ts` - 代理作用域管理
- `model-selection.ts` - 模型选择和回退
- `cli-runner.ts` - CLI代理运行器
- `pi-embedded.ts` - 嵌入式Pi代理
- `workspace.ts` - 工作空间管理

**功能特性**:
- 多模型支持和自动回退
- 会话管理
- 工作空间隔离
- 技能系统集成

### 5. 渠道系统 (`src/channels/`, `extensions/`)

**渠道类型**:

**核心渠道** (内置):
- `src/telegram/` - Telegram集成
- `src/discord/` - Discord集成  
- `src/slack/` - Slack集成
- `src/imessage/` - iMessage集成
- `src/web/` - Web界面

**扩展渠道** (插件):
- `extensions/msteams/` - Microsoft Teams
- `extensions/matrix/` - Matrix协议
- `extensions/whatsapp/` - WhatsApp
- `extensions/signal/` - Signal
- `extensions/line/` - LINE消息

**统一接口**:
所有渠道都实现统一的消息处理接口，支持：
- 消息接收和发送
- 媒体文件处理
- 群组管理
- 权限控制

### 6. 插件系统 (`src/plugins/`)

**核心组件**:
- `loader.ts` - 插件加载器（核心）
- `registry.ts` - 插件注册表
- `discovery.ts` - 插件发现机制
- `hooks.ts` - 钩子系统
- `runtime.ts` - 插件运行时

**插件类型**:
- **渠道插件**: 通信渠道集成
- **内存插件**: 记忆系统扩展
- **认证插件**: OAuth和认证服务
- **工具插件**: 功能扩展
- **服务插件**: 后台服务

### 7. AI提供商集成 (`src/providers/`)

**支持的提供商**:
- Anthropic (Claude)
- OpenAI (GPT系列)
- Google Gemini
- GitHub Copilot
- 通义千问 (Qwen)
- Minimax

**核心文件**:
- `github-copilot-auth.ts` - GitHub Copilot集成
- `google-shared.ts` - Google AI服务
- `qwen-portal-oauth.ts` - 通义千问集成

### 8. 配置系统 (`src/config/`)

**配置管理**:
- 统一的配置系统
- Zod schema验证
- 环境变量支持
- 配置热重载
- 多代理配置

## 关键设计模式

### 1. 依赖注入
```typescript
// src/cli/deps.ts
export function createDefaultDeps(): CliDeps {
  return {
    // 依赖项注入
  };
}
```

### 2. 插件架构
```typescript
// 插件配置示例
{
  "id": "telegram",
  "name": "Telegram",
  "version": "1.0.0",
  "gatewayMethods": ["telegram.send", "telegram.status"]
}
```

### 3. 事件驱动
```typescript
// 代理事件处理
export function createAgentEventHandler({
  broadcast,
  nodeSendToSession,
  // ...
}: AgentEventHandlerOptions) {
  return (evt: AgentEventPayload) => {
    // 事件处理逻辑
  };
}
```

## 数据流向

### 配置数据流
```
配置文件 → 配置加载器 → 配置验证 → 运行时配置 → 各模块使用
```

### 消息数据流
```
渠道接收 → 消息预处理 → 路由解析 → AI处理 → 响应生成 → 渠道发送
```

### 插件数据流
```
插件发现 → 插件加载 → 插件注册 → 钩子绑定 → 运行时调用
```

## 技术栈

### 核心技术
- **语言**: TypeScript (ESM)
- **运行时**: Node.js 22+
- **包管理**: pnpm
- **构建工具**: tsc
- **测试框架**: Vitest

### 开发工具
- **代码格式化**: Oxfmt
- **代码检查**: Oxlint
- **Git钩子**: prek
- **类型检查**: TypeScript

## 部署架构

### 运行模式
1. **本地模式**: 在用户设备上运行
2. **网关模式**: 作为中心服务运行
3. **混合模式**: 本地+远程协作

### 平台支持
- **桌面**: macOS, Windows, Linux
- **移动**: iOS, Android (通过应用)
- **服务器**: Docker, 云平台

## 扩展指南

### 添加新渠道
1. 在 `extensions/` 创建新目录
2. 实现渠道接口
3. 添加 `clawdbot.plugin.json` 配置
4. 实现消息处理逻辑

### 添加新AI提供商
1. 在 `src/providers/` 添加认证逻辑
2. 在 `src/agents/` 添加模型支持
3. 更新配置schema
4. 添加测试用例

### 开发新插件
1. 创建插件目录结构
2. 实现插件接口
3. 添加钩子处理
4. 注册插件方法

## 性能考虑

### 优化策略
- **并发处理**: 支持多会话并发
- **内存管理**: 自动压缩和清理
- **缓存机制**: 模型和配置缓存
- **流式处理**: 实时响应流

### 监控指标
- 响应时间
- 内存使用
- 并发连接数
- 错误率

## 安全机制

### 认证授权
- 多种认证方式支持
- 细粒度权限控制
- 会话安全管理

### 数据保护
- 本地数据存储
- 传输加密
- 敏感信息脱敏

这个架构文档为你提供了Clawdbot项目的全面概览。建议按照快速阅读指南的顺序深入了解各个模块的具体实现。